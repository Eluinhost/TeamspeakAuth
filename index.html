<!DOCTYPE html>
<html>
<head>
    <title></title>
    <link rel="stylesheet" type="text/css" href="css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <style type="text/css">
        body {
            background-image: url('img/pat.png');
        }
        .jumbotron {
            text-align: center;
            background-image: url('img/connecto.png');
        }
        .form-control {
            text-align: center;
            margin: 2px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="jumbotron">
        <h1>Teamspeak Verification</h1>
        <br/>
        <p>Teamspeak verification allows you to be sure of who you are talking to.</p>
        <p>A verified user will have a &#10003; after their name and their client description will be their Minecraft username</p>
        <p><em>To see a clients description, click on them and their description is shown in the right hand side info box</em></p>
        <p>Example: <img src="img/fairy.png"/>
        </p>
        <h1>Verify your account!</h1>
        <form id="auth" action="" method="">
            <h2>Step 1: Enter your current Teamspeak Nickname</h2>
            <input type="text" class="form-control" id="ts_name" placeholder="Current Teamspeak Nickname">
            <div id="request_code_alert" class="alert alert-danger fade in">
                <a class="close alert-close" href="#">&times;</a>
                <span id="request_code_error">Unknown Error</span>
            </div>
            <h2>Step 2: Request Codes and check your messages in Teamspeak</h2>
            <a id="request_codes" class="btn btn-primary btn-md" role="button">Request Codes</a>
            <h2>Step 3: Input Codes</h2>
            <input type="text" class="form-control" id="ts_uuid" placeholder="Teamspeak UUID">
            <input type="text" class="form-control" id="ts_code" placeholder="Teamspeak Auth code">
            <h2>Step 4: Connect to 'auth.publicuhc.com' in Minecraft 1.7</h2>
            <h2>Step 5: Complete the following fields:</h2>
            <input type="text" class="form-control" id="mc_name" placeholder="Minecraft nickname">
            <input type="text" class="form-control" id="code" placeholder="Minecraft Auth code">
            <h2>Step 6: Verify Codes</h2>
            <div id="check_auth_alert" class="alert alert-danger fade in">
                <a class="close alert-close" href="#">&times;</a>
                <span id="check_auth_error">Unknown Error</span>
            </div>
            <div id="auth_success" class="alert alert-success fade in">
                <a class="close alert-close" href="#">&times;</a>
                <span id="auth_success_error">Verified Successfully!</span>
            </div>
            <button id="check_auth" type="submit">Verify Account!</button>
        </form>
        <em>All fields are case sensitive and codes last for 15 minutes after generation.</em>
        <br/>
        <em>Minecraft faces are added based on Minotar and to change inside teamspeak requires reverification</em>
    </div>
</div>
<script src="js/jquery-1.10.2.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script type="text/javascript">
    $(document).ready(function(){

        const OK = 0;
        const INVALID_REQUEST = 1;
        const INVALID_PARAM = 2;
        const TEAMSPEAK_ISSUE = 3;
        const INVALID_TS_UUID = 4;
        const DATABASE_ISSUE = 5;
        const CONFIG_PROBLEM = 6;
        const UNKNOWN_PROBLEM = 7;
        const INVALID_MC_AUTH = 8;
        const INVALID_TS_AUTH = 9;
        const INVALID_TS_NAME = 10;
        const MISSING_PARAM = 11;

        $('#request_codes').click(function(e){
            $('#request_code_alert').hide();
            e.preventDefault();
            $.get("request_teamspeak.php",{'ts_name':$('#ts_name').val()})
            .done(function(data) {
                $('#ts_uuid').val(data['data']);
            })
            .fail(function(xhr) {
                if(typeof xhr.responseJSON === 'undefined'){
                    $('#request_code_error').html('Unexpected response from server');
                }else{
                    var error = 'Unknown error occured';
                    switch(xhr.responseJSON.code){
                        case INVALID_PARAM:
                        case MISSING_PARAM:
                            error = 'Invalid Username';break;
                        case TEAMSPEAK_ISSUE:
                            error = 'Couldn\'t connect to teamspeak, try again later';break;
                        case INVALID_TS_NAME:
                            error = 'Cannot find that username online, check the name given (caps sensitive)';break;
                        case DATABASE_ISSUE:
                            error = 'The was an error accessing the database, please try again later';break;
                    }
                    $('#request_code_error').html(error);
                }
                $('#request_code_alert').show();
            });
        });
        $('#check_auth').click(function(e){
            $('#check_auth_alert').hide();
            e.preventDefault();
            $.get("mc_auth.php",
                {
                    'ts_uuid':$('#ts_uuid').val(),
                    'ts_code':$('#ts_code').val(),
                    'mc_name':$('#mc_name').val(),
                    'code':$('#code').val()
                }
            )
            .done(function(data) {
                $('#auth_success').show();
            })
            .fail(function(xhr) {
                if(typeof xhr.responseJSON === 'undefined'){
                    $('#check_auth_error').html('Unexpected response from server');
                }else{
                    var error = 'Unknown error occured';
                    switch(xhr.responseJSON.code){
                        case INVALID_PARAM:
                        case MISSING_PARAM:
                            error = 'Missing or invalid fields';break;
                        case TEAMSPEAK_ISSUE:
                            error = 'Couldn\'t connect to teamspeak, please try again later';break;
                        case INVALID_TS_UUID:
                            error = 'The Teamspeak UUID is no longer valid, please try again';break;
                        case DATABASE_ISSUE:
                            error = 'The was an error accessing the database, please try again later';break;
                        case INVALID_MC_AUTH:
                            error = 'The given Minecraft auth code was not correct. Please check capitals on both the code and Minecraft username';break;
                        case INVALID_TS_AUTH:
                            error = 'The given Teamspeak auth code was not correct, please check capitals';break;
                    }
                    $('#check_auth_error').html(error);
                }
                $('#check_auth_alert').show();
            });
        });
        $('.alert').hide();
        $('.alert-close').click(function(e){
            e.preventDefault();
           $(this).parent().hide();
        });
    });
</script>
</body>
</html>